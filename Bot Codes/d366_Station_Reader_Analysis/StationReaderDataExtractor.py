import re
from collections import defaultdict
import pandas as pd

# Input log string (replace this with file read if needed)
log_data = """
2025-07-25 08:53:41:   b''
2025-07-25 08:53:47:   b'B7 d275:  | Starting the bot!'
2025-07-25 08:53:55:   b''
2025-07-25 08:53:59:   b'B7 d275:  | Starting the bot! | Time between start and stop: 101 | Frame Count: {95, 88, 89} | Average intensity column 1: {946, 142, 943} | Average intensity column 2: {164, 942, 943} | Average intensity column 3: {76, 121, 941} | Station code: 101011001 | Current Station: D4 | Time between start and stop: 63 | Frame Count: {66, 65, 62} | Average intensity column 1: {928, 915, 99} | Average intensity column 2: {927, 908, 101} | Average intensity column 3: {103, 904, 88} | Station code: 110110010 | Current Station: D5 | Time between start and stop: 51 | Frame Count: {49, 48, 49} | Average intensity column 1: {940, 110, 98} | Average intensity column 2: {153, 938, 942} | Average intensity column 3: {98, 116, 938} | Station code: 100011001 | Current Station: D6 | Time between start and stop: 49 | Frame Count: {49, 49, 49} | Average intensity column 1: {933, 915, 112} | Average intensity column 2: {932, 103, 924} | Average intensity column 3: {935, 920, 119} | Station code: 110101110 | Current Station: D7'
2025-07-25 08:54:03:   b'B7 d275:  | Time between start and stop: 48 | Frame Count: {43, 43, 43} | Average intensity column 1: {949, 77, 74} | Average intensity column 2: {112, 947, 85} | Average intensity column 3: {99, 949, 949} | Station code: 100010011 | Current Station: D8 | Time between start and stop: 47 | Frame Count: {42, 43, 42} | Average intensity column 1: {950, 79, 108} | Average intensity column 2: {947, 75, 115} | Average intensity column 3: {72, 98, 948} | Station code: 100100001 | Current Station: D9 | Time between start and stop: 66 | Frame Count: {70, 70, 67} | Average intensity column 1: {939, 36, 89} | Average intensity column 2: {945, 98, 933} | Average intensity column 3: {62, 938, 937} | Station code: 100101011 | Current Station: D10 | Time between start and stop: 66 | Frame Count: {73, 71, 69} | Average intensity column 1: {927, 55, 63} | Average intensity column 2: {920, 112, 909} | Average intensity column 3: {115, 903, 74} | Station code: 100101010 | Current Station: D11 | Time between start and stop: 64 | Frame Count: {72, 72, 71} | Average intensity column 1: {798, 63, 54} | Average intensity column 2: {840, 110, 854} | Average intensity column 3: {56, 64, 862} | Station code: 100101001 | Current Station: D12 | Time between start and stop: 65 | Frame Count: {71, 70, 71} | Average intensity column 1: {928, 50, 55} | Average intensity column 2: {933, 43, 80} | Average intensity column 3: {931, 875, 105} | Station code: 100100110 | Current Station: D13 | Time between start and stop: 50 | Frame Count: {47, 45, 46} | Average intensity column 1: {928, 100, 168} | Average intensity column 2: {923, 243, 933} | Average intensity column 3: {936, 76, 174} | Station code: 100101100 | Current Station: D14 | Time between start and stop: 49 | Frame Count: {46, 46, 45} | Average intensity column 1: {947, 92, 102} | Average intensity column 2: {942, 92, 122} | Average intensity column 3: {937, 195, 935} | Station code: 100100101 | Current Station: D15 | Time between start and stop: 49 | Frame Count: {47, 46, 43} | Average intensity column 1: {941, 93, 113} | Average intensity column 2: {943, 75, 107} | Average intensity column 3: {151, 942, 941} | Station code: 100100011 | Current Station: D16 | Time between start and stop: 49 | Frame Count: {46, 44, 45} | Average intensity column 1: {948, 73, 93} | Average intensity column 2: {949, 66, 92} | Average intensity column 3: {945, 82, 99} | Station code: 100100100 | Current Station: D17 | Time between start and stop: 50 | Frame Count: {44, 46, 44} | Average intensity column 1: {946, 62, 95} | Average intensity column 2: {940, 75, 109} | Average intensity column 3: {144, 941, 110} | Station code: 100100010 | Current Station: D18'
2025-07-25 08:54:07:   b'B7 d275:  | Time between start and stop: 45 | Frame Count: {41, 38, 40} | Average intensity column 1: {946, 224, 59} | Average intensity column 2: {239, 936, 950} | Average intensity column 3: {947, 947, 187} | Station code: 100011110 | Current Station: D1 | Time between start and stop: 51 | Frame Count: {48, 45, 46} | Average intensity column 1: {956, 21, 139} | Average intensity column 2: {108, 966, 955} | Average intensity column 3: {72, 965, 71} | Station code: 100011010 | Current Station:  | Time between start and stop: 48 | Frame Count: {47, 49, 48} | Average intensity column 1: {95, 924, 928} | Average intensity column 2: {940, 925, 97} | Average intensity column 3: {943, 934, 86} | Station code: 011110110 | Current Station: D2 | Time between start and stop: 49 | Frame Count: {47, 44, 45} | Average intensity column 1: {944, 139, 945} | Average intensity column 2: {951, 947, 68} | Average intensity column 3: {947, 83, 82} | Station code: 101110100 | Current Station: D3 | Time between start and stop: 49 | Frame Count: {44, 42, 43} | Average intensity column 1: {950, 126, 948} | Average intensity column 2: {130, 949, 946} | Average intensity column 3: {60, 99, 949} | Station code: 101011001 | Current Station: D4 | Time between start and stop: 49 | Frame Count: {50, 50, 49} | Average intensity column 1: {927, 903, 97} | Average intensity column 2: {933, 911, 94} | Average intensity column 3: {105, 897, 95} | Station code: 110110010 | Current Station: D5'
2025-07-25 08:54:11:   b'B7 d275:  | Time between start and stop: 49 | Frame Count: {45, 44, 48} | Average intensity column 1: {947, 84, 78} | Average intensity column 2: {143, 942, 944} | Average intensity column 3: {100, 127, 936} | Station code: 100011001 | Current Station: D6 | Time between start and stop: 49 | Frame Count: {50, 49, 49} | Average intensity column 1: {933, 918, 116} | Average intensity column 2: {931, 109, 920} | Average intensity column 3: {932, 910, 121} | Station code: 110101110 | Current Station: D7 | Time between start and stop: 48 | Frame Count: {43, 43, 44} | Average intensity column 1: {950, 73, 68} | Average intensity column 2: {111, 948, 80} | Average intensity column 3: {108, 945, 946} | Station code: 100010011 | Current Station: D8 | Time between start and stop: 46 | Frame Count: {43, 44, 42} | Average intensity column 1: {948, 86, 113} | Average intensity column 2: {945, 81, 115} | Average intensity column 3: {77, 102, 949} | Station code: 100100001 | Current Station: D9 | Time between start and stop: 65 | Frame Count: {71, 69, 67} | Average intensity column 1: {938, 39, 96} | Average intensity column 2: {945, 97, 933} | Average intensity column 3: {69, 939, 937} | Station code: 100101011 | Current Station: D10 | Time between start and stop: 66 | Frame Count: {72, 71, 69} | Average intensity column 1: {935, 49, 64} | Average intensity column 2: {922, 120, 913} | Average intensity column 3: {119, 908, 76} | Station code: 100101010 | Current Station: D11 | Time between start and stop: 64 | Frame Count: {72, 72, 71} | Average intensity column 1: {782, 64, 54} | Average intensity column 2: {837, 108, 845} | Average intensity column 3: {56, 65, 866} | Station code: 100101001 | Current Station: D12 | Time between start and stop: 65 | Frame Count: {71, 71, 71} | Average intensity column 1: {928, 53, 58} | Average intensity column 2: {932, 47, 81} | Average intensity column 3: {932, 864, 105} | Station code: 100100110 | Current Station: D13 | Time between start and stop: 49 | Frame Count: {47, 45, 46} | Average intensity column 1: {928, 103, 180} | Average intensity column 2: {930, 246, 933} | Average intensity column 3: {937, 74, 174} | Station code: 100101100 | Current Station: D14'
2025-07-25 08:54:15:   b'B7 d275:  | Time between start and stop: 49 | Frame Count: {44, 45, 45} | Average intensity column 1: {943, 74, 87} | Average intensity column 2: {944, 82, 115} | Average intensity column 3: {933, 196, 933} | Station code: 100100101 | Current Station: D15 | Time between start and stop: 49 | Frame Count: {47, 47, 43} | Average intensity column 1: {942, 94, 114} | Average intensity column 2: {944, 88, 117} | Average intensity column 3: {154, 945, 940} | Station code: 100100011 | Current Station: D16 | Time between start and stop: 49 | Frame Count: {46, 45, 45} | Average intensity column 1: {949, 75, 95} | Average intensity column 2: {952, 72, 102} | Average intensity column 3: {943, 82, 105} | Station code: 100100100 | Current Station: D17 | Time between start and stop: 49 | Frame Count: {45, 45, 44} | Average intensity column 1: {942, 67, 104} | Average intensity column 2: {943, 67, 105} | Average intensity column 3: {145, 938, 102} | Station code: 100100010 | Current Station: D18 | Time between start and stop: 45 | Frame Count: {41, 38, 40} | Average intensity column 1: {945, 216, 58} | Average intensity column 2: {237, 937, 948} | Average intensity column 3: {946, 943, 199} | Station code: 100011110 | Current Station: D1 | Time between start and stop: 51 | Frame Count: {47, 46, 45} | Average intensity column 1: {958, 15, 146} | Average intensity column 2: {145, 964, 957} | Average intensity column 3: {112, 959, 80} | Station code: 100011010 | Current Station:  | Time between start and stop: 48 | Frame Count: {48, 49, 48} | Average intensity column 1: {102, 924, 927} | Average intensity column 2: {942, 931, 93} | Average intensity column 3: {942, 928, 93} | Station code: 011110110 | Current Station: D2'
2025-07-25 08:54:19:   b'B7 d275:  | Time between start and stop: 49 | Frame Count: {47, 45, 44} | Average intensity column 1: {947, 130, 945} | Average intensity column 2: {954, 948, 77} | Average intensity column 3: {945, 77, 71} | Station code: 101110100 | Current Station: D3 | Time between start and stop: 49 | Frame Count: {45, 42, 44} | Average intensity column 1: {953, 127, 952} | Average intensity column 2: {139, 947, 945} | Average intensity column 3: {74, 113, 947} | Station code: 101011001 | Current Station: D4 | Time between start and stop: 49 | Frame Count: {51, 50, 49} | Average intensity column 1: {932, 914, 106} | Average intensity column 2: {932, 914, 101} | Average intensity column 3: {103, 911, 91} | Station code: 110110010 | Current Station: D5 | Time between start and stop: 49 | Frame Count: {46, 45, 47} | Average intensity column 1: {947, 103, 92} | Average intensity column 2: {151, 942, 944} | Average intensity column 3: {94, 117, 939} | Station code: 100011001 | Current Station: D6 | Time between start and stop: 49 | Frame Count: {49, 49, 49} | Average intensity column 1: {934, 914, 112} | Average intensity column 2: {934, 102, 922} | Average intensity column 3: {939, 923, 117} | Station code: 110101110 | Current Station: D7 | Time between start and stop: 48 | Frame Count: {44, 43, 43} | Average intensity column 1: {952, 69, 70} | Average intensity column 2: {111, 946, 82} | Average intensity column 3: {108, 951, 949} | Station code: 100010011 | Current Station: D8 | Time between start and stop: 47 | Frame Count: {42, 44, 42} | Average intensity column 1: {949, 73, 110} | Average intensity column 2: {942, 80, 120} | Average intensity column 3: {68, 101, 949} | Station code: 100100001 | Current Station: D9 | Time between start and stop: 66 | Frame Count: {70, 69, 67} | Average intensity column 1: {940, 35, 86} | Average intensity column 2: {946, 93, 932} | Average intensity column 3: {80, 935, 932} | Station code: 100101011 | Current Station: D10 | Time between start and stop: 66 | Frame Count: {72, 71, 68} | Average intensity column 1: {934, 48, 67} | Average intensity column 2: {922, 124, 914} | Average intensity column 3: {119, 910, 77} | Station code: 100101010 | Current Station: D11'
2025-07-25 08:54:23:   b'B7 d275:  | Time between start and stop: 64 | Frame Count: {73, 72, 71} | Average intensity column 1: {799, 68, 57} | Average intensity column 2: {789, 113, 809} | Average intensity column 3: {56, 64, 875} | Station code: 100101001 | Current Station: D12 | Time between start and stop: 65 | Frame Count: {71, 71, 72} | Average intensity column 1: {928, 56, 60} | Average intensity column 2: {931, 49, 87} | Average intensity column 3: {934, 887, 110} | Station code: 100100110 | Current Station: D13 | Time between start and stop: 49 | Frame Count: {47, 45, 46} | Average intensity column 1: {930, 102, 174} | Average intensity column 2: {926, 245, 934} | Average intensity column 3: {937, 76, 178} | Station code: 100101100 | Current Station: D14 | Time between start and stop: 49 | Frame Count: {44, 45, 45} | Average intensity column 1: {945, 74, 86} | Average intensity column 2: {947, 87, 114} | Average intensity column 3: {937, 195, 939} | Station code: 100100101 | Current Station: D15 | Time between start and stop: 49 | Frame Count: {46, 46, 42} | Average intensity column 1: {941, 86, 106} | Average intensity column 2: {947, 79, 105} | Average intensity column 3: {136, 949, 944} | Station code: 100100011 | Current Station: D16 | Time between start and stop: 49 | Frame Count: {45, 44, 45} | Average intensity column 1: {947, 70, 91} | Average intensity column 2: {949, 69, 95} | Average intensity column 3: {945, 83, 101} | Station code: 100100100 | Current Station: D17 | Time between start and stop: 50 | Frame Count: {45, 45, 43} | Average intensity column 1: {947, 69, 102} | Average intensity column 2: {943, 71, 103} | Average intensity column 3: {138, 941, 102} | Station code: 100100010 | Current Station: D18 | Time between start and stop: 45 | Frame Count: {41, 38, 39} | Average intensity column 1: {946, 215, 55} | Average intensity column 2: {243, 938, 948} | Average intensity column 3: {947, 944, 196} | Station code: 100011110 | Current Station: D1'
2025-07-25 08:54:27:   b'B7 d275:  | Time between start and stop: 51 | Frame Count: {48, 44, 46} | Average intensity column 1: {958, 23, 140} | Average intensity column 2: {145, 964, 955} | Average intensity column 3: {100, 964, 100} | Station code: 100011010 | Current Station:  | Time between start and stop: 48 | Frame Count: {47, 48, 48} | Average intensity column 1: {90, 926, 930} | Average intensity column 2: {940, 928, 86} | Average intensity column 3: {943, 930, 89} | Station code: 011110110 | Current Station: D2 | Time between start and stop: 52 | Frame Count: {49, 47, 48} | Average intensity column 1: {946, 124, 947} | Average intensity column 2: {953, 948, 66} | Average intensity column 3: {948, 74, 72} | Station code: 101110100 | Current Station: D3 | Time between start and stop: 56 | Frame Count: {50, 48, 50} | Average intensity column 1: {950, 127, 948} | Average intensity column 2: {137, 950, 948} | Average intensity column 3: {71, 107, 948} | Station code: 101011001 | Current Station: D4 | Time between start and stop: 59 | Frame Count: {61, 60, 59} | Average intensity column 1: {933, 914, 105} | Average intensity column 2: {934, 916, 99} | Average intensity column 3: {108, 892, 98} | Station code: 110110010 | Current Station: D5 | Time between start and stop: 63 | Frame Count: {59, 57, 61} | Average intensity column 1: {948, 105, 93} | Average intensity column 2: {146, 942, 944} | Average intensity column 3: {96, 121, 939} | Station code: 100011001 | Current Station: D6 | Time between start and stop: 68 | Frame Count: {67, 67, 69} | Average intensity column 1: {935, 920, 109} | Average intensity column 2: {935, 102, 924} | Average intensity column 3: {935, 918, 120} | Station code: 110101110 | Current Station: D7'
2025-07-25 08:54:31:   b'B7 d275:  | Time between start and stop: 151 | Frame Count: {141, 127, 135} | Average intensity column 1: {957, 59, 67} | Average intensity column 2: {62, 956, 51} | Average intensity column 3: {72, 956, 954} | Station code: 100010011 | Current Station: D8 | Time between start and stop: 286 | Frame Count: {254, 258, 266} | Average intensity column 1: {948, 79, 102} | Average intensity column 2: {951, 71, 108} | Average intensity column 3: {81, 99, 949} | Station code: 100100001 | Current Station: D9'
"""

# Compile pattern
pattern = re.compile(
    r"Time between start and stop: (\d+)\s*\| Frame Count: \{([\d,\s]+)\} \| Average intensity column 1: \{([\d,\s]+)\} \| Average intensity column 2: \{([\d,\s]+)\} \| Average intensity column 3: \{([\d,\s]+)\} \| Station code: (\d+) \| Current Station: (\w+)"
)

# Parse entries
station_entries = defaultdict(list)

for match in pattern.finditer(log_data):
    time = int(match.group(1))
    frame_count = "{" + match.group(2).replace(" ", "") + "}"
    avg_col1 = "{" + match.group(3).replace(" ", "") + "}"
    avg_col2 = "{" + match.group(4).replace(" ", "") + "}"
    avg_col3 = "{" + match.group(5).replace(" ", "") + "}"
    station_code = match.group(6)
    station_id = match.group(7)

    station_entries[station_id].append({
        "Time of Read": time,
        "Frame Count": frame_count,
        "Avg Intensity Col 1": avg_col1,
        "Avg Intensity Col 2": avg_col2,
        "Avg Intensity Col 3": avg_col3,
        "Station Code": station_code
    })

# Write Excel with openpyxl
with pd.ExcelWriter("C:\\Users\\User\\Dropbox\\X1 M-Sort development work\\S (Shared) X1 mSort\\M-Sort Electronics\\Tushar Garg\\station_data.xlsx", engine="openpyxl") as writer:
    for station, records in station_entries.items():
        # Extract station code from the first record
        station_code = records[0]["Station Code"]
        # Build DataFrame
        df = pd.DataFrame([{
            "Round": f"Round {i+1}",
            "Frame Count": r["Frame Count"],
            "Avg Intensity Col 1": r["Avg Intensity Col 1"],
            "Avg Intensity Col 2": r["Avg Intensity Col 2"],
            "Avg Intensity Col 3": r["Avg Intensity Col 3"],
            "Time of Read": r["Time of Read"]
        } for i, r in enumerate(records)])

        # Write station code on first row
        df.to_excel(writer, sheet_name=station, startrow=2, index=False)
        sheet = writer.book[station]
        sheet.cell(row=1, column=1).value = f"Station Code: {station_code}"